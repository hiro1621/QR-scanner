<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>å‡¦æ–¹ç®‹é€ä¿¡</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; text-align: center; background-color: #f0f2f5; color: #333; }
    h2 { margin-bottom: 15px; font-size: 1.3rem; color: #111; }
    
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; text-align: left; }
    .label { font-size: 0.75rem; color: #888; margin-top: 12px; font-weight: bold; }
    .value { font-size: 1.1rem; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 4px; min-height: 24px; color: #333; }
    .drug-list { font-size: 0.95rem; background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 5px; white-space: pre-wrap; line-height: 1.6; max-height: 300px; overflow-y: auto; border: 1px solid #eee; color: #444; }

    .btn { display: block; width: 100%; padding: 16px 0; border: none; border-radius: 50px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-bottom: 15px; transition: transform 0.1s; }
    .btn-camera { background-color: #06C755; color: white; box-shadow: 0 4px 10px rgba(6, 199, 85, 0.3); }
    .btn-send { background-color: #007AFF; color: white; box-shadow: 0 4px 10px rgba(0, 122, 255, 0.3); }
    .btn-reset { background-color: #666; color: white; font-size: 0.9rem; padding: 10px 0; margin-top: 20px; box-shadow: none; }
    .btn:active { transform: scale(0.98); }
    
    .counter { background: #333; color: #fff; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; display: inline-block; margin-bottom: 10px; }

    #raw-data-area { display: none; margin-top: 30px; text-align: left; }
    #raw-text { width: 100%; height: 100px; font-size: 10px; background: #eee; border: 1px solid #999; }
    .debug-link { font-size: 10px; color: #aaa; text-decoration: underline; cursor: pointer; display: block; margin-top: 20px;}
  </style>
</head>
<body>

  <h2>å‡¦æ–¹ç®‹å—ä»˜</h2>
  
  <div id="scan-status" style="margin-bottom:10px;">
    <span class="counter" id="qr-count">èª­ã¿å–ã‚Šæ•°: 0æš</span>
  </div>

  <div class="card">
    <div class="label">ãŠåå‰</div>
    <div class="value" id="disp-name"><span style="color:#ccc; font-weight:normal;">(æœªæ¤œå‡º)</span></div>
    
    <div class="label">ãƒ•ãƒªã‚¬ãƒŠ</div>
    <div class="value" id="disp-kana"><span style="color:#ccc; font-weight:normal;">(æœªæ¤œå‡º)</span></div>
    
    <div class="label">ç”Ÿå¹´æœˆæ—¥</div>
    <div class="value" id="disp-birth"><span style="color:#ccc; font-weight:normal;">(æœªæ¤œå‡º)</span></div>

    <div class="label">å‡¦æ–¹å†…å®¹</div>
    <div class="drug-list" id="disp-drugs">ï¼ˆèª­ã¿å–ã‚Šå¾…æ©Ÿä¸­...ï¼‰</div>
  </div>

  <button class="btn btn-camera" onclick="startScan()">ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</button>
  <button class="btn btn-send" id="send-btn" onclick="goToJotForm()" style="display:none;">é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€</button>
  <button class="btn btn-reset" onclick="resetAll()">ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
  
  <p id="msg" style="font-size:0.8rem; color:#999; margin-top:20px;">æº–å‚™å®Œäº†</p>

  <span class="debug-link" onclick="toggleDebug()">[è§£æã§ããªã„å ´åˆã¯ã“ã“ã‚’ã‚¿ãƒƒãƒ—]</span>
  <div id="raw-data-area">
    <p style="font-size:10px; margin:0;">èª­ã¿å–ã‚Šãƒ‡ãƒ¼ã‚¿(ç”Ÿ):</p>
    <textarea id="raw-text"></textarea>
  </div>

  <script>
    const MY_LIFF_ID = "2008819728-et8sw7Ou"; 
    const JOTFORM_ID = "253620819353054";

    let scannedTexts = []; 
    let patientInfo = { name: "", kana: "", birth: "" };
    let drugList = [];

    window.onload = function() {
      liff.init({ liffId: MY_LIFF_ID })
        .then(() => { if (!liff.isLoggedIn()) liff.login(); })
        .catch((err) => { document.getElementById('msg').innerText = "åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: " + err; });
    };

    async function startScan() {
      if (!liff.isInClient()) { alert("LINEã‚¢ãƒ—ãƒªå†…ã‹ã‚‰é–‹ã„ã¦ãã ã•ã„"); return; }
      try {
        const result = await liff.scanCodeV2();
        if (result.value) {
           processQrData(result.value);
        }
      } catch (err) { console.error(err); }
    }

    function processQrData(text) {
      if (scannedTexts.includes(text)) { 
        alert("ã€ç¢ºèªã€‘ãã®QRã‚³ãƒ¼ãƒ‰ã¯æ—¢ã«èª­ã¿å–ã£ã¦ã„ã¾ã™ã€‚\nåˆ¥ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚"); 
        return; 
      }
      
      scannedTexts.push(text);
      document.getElementById('raw-text').value = scannedTexts.join("\n\n----------------\n\n");
      
      try {
        analyzeAllData(); 
        updateUI();
        alert("èª­ã¿å–ã‚ŠæˆåŠŸï¼\n" + (scannedTexts.length) + "æšç›®ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚");
        document.getElementById('msg').innerText = "æ¬¡ã®QRã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Œã°èª­ã¿å–ã£ã¦ãã ã•ã„";
      } catch (e) {
        alert("ãƒ‡ãƒ¼ã‚¿è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e);
      }
    }

    function analyzeAllData() {
      drugList = []; 
      
      scannedTexts.forEach(rawText => {
        const lines = rawText.split(/\r\n|\n|\r/);
        
        lines.forEach(line => {
          const cols = line.split(','); 
          
          // â–  11: æ‚£è€…æƒ…å ±
          if (cols[0] === "11") {
            if (cols[2]) patientInfo.name = cols[2]; 
            if (cols[3]) patientInfo.kana = cols[3]; 
            if (cols[5] && cols[5].match(/^\d{8}$/)) patientInfo.birth = cols[5]; 
          }

          // â–  13: ç”Ÿå¹´æœˆæ—¥ (JAHIS V13ä»¥é™å¯¾å¿œ)
          if (cols[0] === "13") {
            if (cols[1]) patientInfo.birth = cols[1];
          }

          // â–  111: ç”¨æ³•
          if (cols[0] === "111") {
            if (cols[4]) drugList.push("ã€ç”¨æ³•ã€‘" + cols[4]);
          }

          // â–  201: è–¬å“æƒ…å ±
          if (cols[0] === "201") {
            const drugName = cols[6];
            const amount = cols[7];
            const unit = cols[9];
            
            if (drugName) {
              let info = "ãƒ»" + drugName;
              if (amount && unit) info += ` (${amount}${unit})`;
              drugList.push(info);
            }
          }
        });
        
        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        if (!patientInfo.birth) {
            const dateMatch = rawText.match(/(19|20)\d{6}/);
            if (dateMatch) patientInfo.birth = dateMatch[0];
        }
      });
    }

    function updateUI() {
      document.getElementById('qr-count').innerText = "èª­ã¿å–ã‚Šæ•°: " + scannedTexts.length + "æš";
      if (patientInfo.name) document.getElementById('disp-name').innerText = patientInfo.name;
      if (patientInfo.kana) document.getElementById('disp-kana').innerText = patientInfo.kana;
      if (patientInfo.birth) document.getElementById('disp-birth').innerText = patientInfo.birth;

      if (drugList.length > 0) {
        document.getElementById('disp-drugs').innerText = drugList.join("\n");
      } else {
        document.getElementById('disp-drugs').innerText = "ï¼ˆè–¬å“æƒ…å ±ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸï¼‰";
      }

      if (patientInfo.name || patientInfo.birth) {
        document.getElementById('send-btn').style.display = "block";
      }
    }

    function resetAll() {
      if(!confirm("èª­ã¿å–ã£ãŸå†…å®¹ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¦ã€æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ")) return;
      scannedTexts = [];
      patientInfo = { name: "", kana: "", birth: "" };
      drugList = [];
      document.getElementById('disp-name').innerHTML = '<span style="color:#ccc; font-weight:normal;">(æœªæ¤œå‡º)</span>';
      document.getElementById('disp-kana').innerHTML = '<span style="color:#ccc; font-weight:normal;">(æœªæ¤œå‡º)</span>';
      document.getElementById('disp-birth').innerHTML = '<span style="color:#ccc; font-weight:normal;">(æœªæ¤œå‡º)</span>';
      document.getElementById('disp-drugs').innerText = "ï¼ˆèª­ã¿å–ã‚Šå¾…æ©Ÿä¸­...ï¼‰";
      document.getElementById('qr-count').innerText = "èª­ã¿å–ã‚Šæ•°: 0æš";
      document.getElementById('send-btn').style.display = "none";
      document.getElementById('msg').innerText = "ãƒªã‚»ãƒƒãƒˆå®Œäº†";
    }

    function toggleDebug() {
       const area = document.getElementById('raw-data-area');
       area.style.display = (area.style.display === 'none' || area.style.display === '') ? 'block' : 'none';
    }

    function goToJotForm() {
      const params = new URLSearchParams();
      if (patientInfo.name) params.append("name", patientInfo.name);
      if (patientInfo.kana) params.append("kana", patientInfo.kana);
      if (patientInfo.birth) params.append("birthdate", patientInfo.birth);
      if (drugList.length > 0) params.append("prescription", drugList.join("\n"));

      liff.openWindow({
        url: `https://form.jotform.com/${JOTFORM_ID}?${params.toString()}`,
        external: false
      });
    }
  </script>
</body>
</html>