<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‡¦æ–¹ç®‹QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ Ver 5.0</title>
    <!-- Bundled ZXing-WASM (tested and working!) -->
    <script src="zxing-bundle.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1a1a2e;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: #16213e;
            padding: 12px;
            text-align: center;
            font-size: 14px;
            border-bottom: 2px solid #0f3460;
        }

        #camera-container {
            flex: 1;
            position: relative;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #guide {
            position: absolute;
            width: 80%;
            height: 60%;
            border: 3px solid #00ff88;
            border-radius: 12px;
            pointer-events: none;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        #result-panel {
            background: #fff;
            color: #333;
            padding: 15px;
            max-height: 45vh;
            overflow-y: auto;
        }

        #status {
            font-weight: bold;
            padding: 10px;
            background: #fff3cd;
            color: #856404;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #status.success {
            background: #d4edda;
            color: #155724;
        }

        #status.error {
            background: #f8d7da;
            color: #721c24;
        }

        #output {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
            max-height: 180px;
            overflow-y: auto;
            border-radius: 8px;
        }

        #debug {
            margin-top: 8px;
            background: #222;
            color: #0f0;
            padding: 8px;
            font-family: monospace;
            font-size: 9px;
            max-height: 80px;
            overflow-y: auto;
            border-radius: 4px;
        }

        button {
            margin-top: 10px;
            padding: 14px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
        }

        button:active {
            opacity: 0.8;
        }

        button:disabled {
            background: #999;
        }
    </style>
</head>

<body>
    <header>ğŸ“‹ å‡¦æ–¹ç®‹QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ Ver 5.0 (æ¤œè¨¼æ¸ˆã¿ZXing)</header>

    <div id="camera-container">
        <video id="video" autoplay playsinline muted></video>
        <div id="guide"></div>
    </div>

    <div id="result-panel">
        <div id="status">
            <span id="status-icon">â³</span>
            <span id="status-text">åˆæœŸåŒ–ä¸­...</span>
        </div>
        <div id="output">ã“ã“ã«èª­ã¿å–ã‚ŠçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        <div id="debug">[ãƒ­ã‚°]</div>
        <button id="btn-reset" onclick="resetScan()">ğŸ”„ ã‚‚ã†ä¸€åº¦ã‚¹ã‚­ãƒ£ãƒ³</button>
    </div>

    <canvas id="canvas" hidden></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const statusEl = document.getElementById('status');
        const statusIcon = document.getElementById('status-icon');
        const statusText = document.getElementById('status-text');
        const outputEl = document.getElementById('output');
        const debugEl = document.getElementById('debug');
        const btnReset = document.getElementById('btn-reset');

        let scanning = false;
        let stream = null;
        let scanInterval = null;

        function log(msg) {
            const t = new Date().toLocaleTimeString();
            console.log(`[${t}] ${msg}`);
            debugEl.textContent = `[${t}] ${msg}\n` + debugEl.textContent;
        }

        function setStatus(type, msg) {
            statusEl.className = type;
            statusText.textContent = msg;
            if (type === 'success') statusIcon.textContent = 'âœ…';
            else if (type === 'error') statusIcon.textContent = 'âŒ';
            else statusIcon.textContent = 'ğŸ“·';
        }

        async function startCamera() {
            log('ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...');
            setStatus('', 'ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...');

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                });

                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    log(`è§£åƒåº¦: ${video.videoWidth}x${video.videoHeight}`);
                    video.play();
                    startScanning();
                };

            } catch (err) {
                log('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ' + err.message);
                setStatus('error', 'ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—');
                alert('ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n' + err.message);
            }
        }

        function startScanning() {
            scanning = true;
            setStatus('', 'QRã‚³ãƒ¼ãƒ‰ã‚’æ å†…ã«æ˜ ã—ã¦ãã ã•ã„');
            log('ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹');
            scanInterval = setInterval(scanFrame, 250);
        }

        async function scanFrame() {
            if (!scanning) return;
            if (video.readyState !== video.HAVE_ENOUGH_DATA) return;

            try {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                const results = await window.ZXingScanner.readBarcodes(imageData, {
                    formats: ['QRCode'],
                    tryHarder: true,
                    tryRotate: true,
                    tryInvert: false,
                    tryDownscale: true,
                    maxNumberOfSymbols: 1
                });

                if (results.length > 0) {
                    handleSuccess(results[0]);
                }
            } catch (e) {
                // No QR - normal
            }
        }

        function handleSuccess(result) {
            scanning = false;
            if (scanInterval) clearInterval(scanInterval);

            log('QRã‚³ãƒ¼ãƒ‰æ¤œå‡ºï¼');

            const text = result.text;

            if (text.startsWith('JAHIS')) {
                log('JAHISå½¢å¼ç¢ºèªOK');
            } else {
                log('æ³¨æ„: JAHISå½¢å¼ã§ã¯ãªã„å¯èƒ½æ€§');
            }

            setStatus('success', 'èª­ã¿å–ã‚ŠæˆåŠŸï¼');
            outputEl.textContent = text;

            if (navigator.vibrate) navigator.vibrate(200);
        }

        function resetScan() {
            log('ãƒªã‚»ãƒƒãƒˆ');
            outputEl.textContent = 'ã‚¹ã‚­ãƒ£ãƒ³ä¸­...';
            setStatus('', 'QRã‚³ãƒ¼ãƒ‰ã‚’æ å†…ã«æ˜ ã—ã¦ãã ã•ã„');
            scanning = true;
            scanInterval = setInterval(scanFrame, 250);
        }

        function stopCamera() {
            scanning = false;
            if (scanInterval) clearInterval(scanInterval);
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
            }
        }

        // Init
        window.onload = () => {
            log('ã‚¢ãƒ—ãƒªèµ·å‹•');

            if (typeof window.ZXingScanner === 'undefined' || !window.ZXingScanner.readBarcodes) {
                log('FATAL: ZXingScanner ãªã—');
                setStatus('error', 'ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­è¾¼å¤±æ•—');
                alert('ZXingãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nzxing-bundle.js ã‚’é…ç½®ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            log('ZXingScanner èª­è¾¼OK');
            startCamera();
        };

        window.onbeforeunload = stopCamera;
    </script>
</body>

</html>
