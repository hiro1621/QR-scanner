<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>高速QRスキャナー</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        #header {
            padding: 10px;
            background: #222;
            text-align: center;
            font-size: 14px;
            color: #ccc;
            z-index: 10;
        }

        #camera-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #scan-line {
            position: absolute;
            width: 80%;
            height: 2px;
            background: #0f0;
            box-shadow: 0 0 4px #0f0;
            top: 50%;
            left: 10%;
            animation: scan 2s infinite linear;
            z-index: 5;
            pointer-events: none;
        }

        @keyframes scan {
            0% {
                top: 10%;
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                top: 90%;
                opacity: 0;
            }
        }

        #result-area {
            height: 35%;
            background: #fff;
            color: #333;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
            z-index: 20;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #status {
            font-weight: bold;
            margin-bottom: 5px;
            color: #444;
            display: flex;
            justify-content: space-between;
        }

        #raw-data {
            flex: 1;
            width: 100%;
            border: 1px solid #ddd;
            background: #f9f9f9;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            overflow-y: auto;
            white-space: pre-wrap;
            resize: none;
        }

        #btn-reset {
            margin-top: 10px;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        #btn-reset:active {
            background: #0056b3;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>

    <div id="header">JAHIS QR Scanner Prototype Ver 4.5</div>

    <div id="camera-container">
        <video id="video" autoplay playsinline muted></video>
        <div id="scan-line"></div>
    </div>

    <div id="result-area">
        <div id="status">
            <span>ステータス: <span id="status-text">カメラ起動中...</span></span>
        </div>
        <textarea id="raw-data" readonly placeholder="ここに読み取ったデータが表示されます"></textarea>
        <!-- 下記ボタンは読み取り後に表示 -->
        <button id="btn-reset" onclick="resetScan()">続けて読み取る</button>
    </div>

    <!-- Hidden Canvas for Processing -->
    <canvas id="canvas" hidden></canvas>

    <script>
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d", { willReadFrequently: true });
        const rawDataArea = document.getElementById("raw-data");
        const statusText = document.getElementById("status-text");
        const scanLine = document.getElementById("scan-line");

        let scanning = true;

        // Camera Initialization
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment",
                        width: { ideal: 1280 }, // Good balance
                        height: { ideal: 720 }
                    }
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    requestAnimationFrame(scanLoop);
                    statusText.textContent = "スキャン中...";
                };
            } catch (err) {
                console.error(err);
                statusText.textContent = "カメラエラー: " + err.name;
                alert("カメラの起動に失敗しました。\n権限を確認してください。");
            }
        }

        // Main Loop
        function scanLoop() {
            if (!scanning) return;

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                // jsQR Scan
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    handleSuccess(code);
                }
            }
            if (scanning) requestAnimationFrame(scanLoop);
        }

        // Handle Found Code
        function handleSuccess(code) {
            // 1. Decode
            const rawBytes = code.binaryData;
            let decodedText = "";

            try {
                // FORCE SHIFT-JIS for JAHIS
                const decoder = new TextDecoder("shift-jis");
                decodedText = decoder.decode(new Uint8Array(rawBytes));
            } catch (e) {
                decodedText = "Decode Error: " + e.message;
            }

            // 2. UI Update
            scanning = false; // Stop loop
            scanLine.style.display = "none"; // Hide scan line
            statusText.textContent = "読み取り成功！";
            statusText.style.color = "green";

            // Show Data
            const timestamp = new Date().toLocaleTimeString();
            rawDataArea.value = `[${timestamp}] 読み取り完了\n\n${decodedText}`;

            // Feedback
            if (navigator.vibrate) navigator.vibrate(200);

            // Note: We stop scanning until user hits "Reset"
        }

        // Reset to scan again
        function resetScan() {
            scanning = true;
            rawDataArea.value = "";
            statusText.textContent = "スキャン中...";
            statusText.style.color = "#444";
            scanLine.style.display = "block";
            requestAnimationFrame(scanLoop);
        }

        // Start on Load
        window.onload = () => {
            if (typeof jsQR === 'undefined') {
                alert("jsQRライブラリの読み込みに失敗しました。ネット環境を確認してください。");
                return;
            }
            startCamera();
        };
    </script>
</body>

</html>
