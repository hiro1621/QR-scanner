<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‡¦æ–¹ç®‹QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ Ver 5.1</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1a1a2e;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: #16213e;
            padding: 10px;
            text-align: center;
            font-size: 13px;
        }

        #reader {
            width: 100%;
            flex: 1;
            min-height: 350px;
            background: #000;
        }

        #result-panel {
            background: #fff;
            color: #333;
            padding: 12px;
            max-height: 40vh;
            overflow-y: auto;
        }

        #status {
            font-weight: bold;
            padding: 10px;
            background: #fff3cd;
            color: #856404;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        #status.success {
            background: #d4edda;
            color: #155724;
        }

        #status.error {
            background: #f8d7da;
            color: #721c24;
        }

        #output {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            font-family: monospace;
            font-size: 10px;
            white-space: pre-wrap;
            max-height: 120px;
            overflow-y: auto;
            border-radius: 8px;
        }

        #debug {
            margin-top: 6px;
            background: #222;
            color: #0f0;
            padding: 6px;
            font-family: monospace;
            font-size: 9px;
            max-height: 100px;
            overflow-y: auto;
            border-radius: 4px;
        }

        button {
            margin-top: 8px;
            padding: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            width: 100%;
        }
    </style>
</head>

<body>
    <header>ğŸ“‹ å‡¦æ–¹ç®‹QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ Ver 5.1 (ãƒã‚¤ãƒ†ã‚£ãƒ–æ¤œå‡ºãƒ†ã‚¹ãƒˆ)</header>
    <div id="reader"></div>
    <div id="result-panel">
        <div id="status">ğŸ“· åˆæœŸåŒ–ä¸­...</div>
        <div id="output">ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        <div id="debug">[ãƒ­ã‚°]</div>
        <button onclick="resetScan()">ğŸ”„ ã‚‚ã†ä¸€åº¦ã‚¹ã‚­ãƒ£ãƒ³</button>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const outputEl = document.getElementById('output');
        const debugEl = document.getElementById('debug');
        let html5QrCode = null;
        let isScanning = false;

        function log(msg) {
            const t = new Date().toLocaleTimeString();
            console.log(`[${t}] ${msg}`);
            debugEl.textContent = `[${t}] ${msg}\n` + debugEl.textContent;
        }

        function setStatus(type, msg) {
            statusEl.className = type;
            statusEl.textContent = msg;
        }

        // æˆåŠŸæ™‚
        function onScanSuccess(decodedText, decodedResult) {
            log('æ¤œå‡ºæˆåŠŸï¼');
            log('å½¢å¼: ' + (decodedResult.result.format?.formatName || 'QR'));

            stopScan();

            setStatus('success', 'âœ… èª­ã¿å–ã‚ŠæˆåŠŸï¼');
            outputEl.textContent = decodedText;

            // JAHISåˆ¤å®š
            if (decodedText.startsWith('JAHIS')) {
                log('JAHISå½¢å¼OK');
            } else {
                log('æ³¨æ„: JAHISå½¢å¼ã§ã¯ãªã„ã‹ã‚‚');
            }

            if (navigator.vibrate) navigator.vibrate(200);
        }

        // ã‚¨ãƒ©ãƒ¼æ™‚ï¼ˆQRè¦‹ã¤ã‹ã‚‰ãªã„ = æ­£å¸¸ãªã®ã§ç„¡è¦–ï¼‰
        function onScanError(err) {
            // ä½•ã‚‚ã—ãªã„
        }

        async function startScan() {
            log('ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹...');
            setStatus('', 'ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚’æ˜ ã—ã¦ãã ã•ã„');

            try {
                // ãƒã‚¤ãƒ†ã‚£ãƒ–BarcodeDetectorã‚’ä½¿ã†è¨­å®š
                await html5QrCode.start(
                    { facingMode: "environment" },
                    {
                        fps: 10,
                        qrbox: { width: 280, height: 280 },
                        // ãƒã‚¤ãƒ†ã‚£ãƒ–æ¤œå‡ºã‚’æœ‰åŠ¹åŒ–ï¼ˆãŠè–¬æ‰‹å¸³ã‚¢ãƒ—ãƒªã¨åŒã˜æ–¹å¼ï¼‰
                        experimentalFeatures: {
                            useBarCodeDetectorIfSupported: true
                        }
                    },
                    onScanSuccess,
                    onScanError
                );
                isScanning = true;

                // ãƒã‚¤ãƒ†ã‚£ãƒ–æ¤œå‡ºãŒä½¿ãˆã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if ('BarcodeDetector' in window) {
                    log('ãƒã‚¤ãƒ†ã‚£ãƒ–BarcodeDetector: åˆ©ç”¨å¯èƒ½');
                } else {
                    log('ãƒã‚¤ãƒ†ã‚£ãƒ–BarcodeDetector: åˆ©ç”¨ä¸å¯ï¼ˆjsQRãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰');
                }

                log('ã‚«ãƒ¡ãƒ©èµ·å‹•OK');
            } catch (err) {
                log('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ' + err);
                setStatus('error', 'âŒ ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—');
                alert('ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—:\n' + err);
            }
        }

        async function stopScan() {
            if (html5QrCode && isScanning) {
                try {
                    await html5QrCode.stop();
                    isScanning = false;
                } catch (e) { }
            }
        }

        async function resetScan() {
            log('ãƒªã‚»ãƒƒãƒˆ');
            outputEl.textContent = 'ã‚¹ã‚­ãƒ£ãƒ³ä¸­...';
            await startScan();
        }

        window.onload = async () => {
            log('ã‚¢ãƒ—ãƒªèµ·å‹•');

            if (typeof Html5Qrcode === 'undefined') {
                log('FATAL: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã—');
                setStatus('error', 'âŒ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­è¾¼å¤±æ•—');
                return;
            }

            log('Html5Qrcode èª­è¾¼OK');
            html5QrCode = new Html5Qrcode("reader");
            await startScan();
        };
    </script>
</body>

</html>
