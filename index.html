<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‡¦æ–¹ç®‹å—ä»˜</title>
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- jsQR library via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 15px;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            margin: 0;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            font-size: 1.4rem;
            margin: 0 0 5px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .version {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem;
            margin-bottom: 15px;
        }

        /* Instructions */
        .instructions {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            color: white;
            font-size: 0.85rem;
            line-height: 1.6;
            margin-bottom: 15px;
            text-align: left;
        }

        .instructions strong {
            display: block;
            margin-bottom: 5px;
        }

        /* Camera / Canvas Area */
        #media-container {
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
            display: none;
            /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
        }

        video {
            width: 100%;
            height: auto;
            display: block;
        }

        /* Buttons */
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 14px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #06C755, #00B341);
            color: white;
            box-shadow: 0 4px 15px rgba(6, 199, 85, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4A90D9, #357ABD);
            color: white;
            box-shadow: 0 4px 15px rgba(74, 144, 217, 0.4);
        }

        .btn-stop {
            background: linear-gradient(135deg, #FF6B6B, #EE5A5A);
            color: white;
            display: none;
        }

        .btn-submit {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-reset {
            background: #888;
            color: white;
        }

        .hidden {
            display: none !important;
        }

        /* Status & Result Card */
        .card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            text-align: left;
            margin-bottom: 15px;
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: #f0f2f5;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .status-icon {
            font-size: 1.5rem;
        }

        .status-text {
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }

        .status-bar.success {
            background: #d4edda;
        }

        .status-bar.success .status-text {
            color: #155724;
        }

        .status-bar.processing {
            background: #fff3cd;
        }

        .status-bar.processing .status-text {
            color: #856404;
        }

        /* Fields */
        .field {
            margin-bottom: 12px;
        }

        .field-label {
            font-size: 0.7rem;
            color: #888;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .field-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            min-height: 30px;
        }

        .drug-list {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 10px;
            font-size: 0.95rem;
            white-space: pre-wrap;
            line-height: 1.7;
            max-height: 200px;
            overflow-y: auto;
            color: #444;
        }

        #file-input {
            display: none;
        }

        #debug-log {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            text-align: left;
            margin-top: 20px;
            white-space: pre-wrap;
            display: none;
            /* ãƒ‡ãƒãƒƒã‚°ç”¨ */
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ“‹ å‡¦æ–¹ç®‹å—ä»˜</h1>
        <div class="version">Ver 4.2 (JAHIS å¯¾å¿œç‰ˆ)</div>

        <div class="instructions">
            <strong>ğŸ“¸ ä½¿ã„æ–¹</strong>
            ã€Œå†™çœŸã‚’æ’®ã£ã¦èª­ã¿å–ã‚‹ã€ãƒœã‚¿ãƒ³ã§ã€å‡¦æ–¹ç®‹ã®QRã‚³ãƒ¼ãƒ‰ã‚’æ’®å½±ã—ã¦ãã ã•ã„ã€‚<br>
            â€»QRã‚³ãƒ¼ãƒ‰ãŒè¤‡æ•°ã‚ã‚‹å ´åˆï¼ˆé€£çµQRï¼‰ã‚‚å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚
        </div>

        <div id="media-container">
            <video id="video" playsinline muted autoplay></video>
            <canvas id="canvas" style="display:none;"></canvas>
        </div>

        <div class="btn-group">
            <button id="btn-photo" class="btn btn-primary" onclick="takePhoto()">
                ğŸ“¸ å†™çœŸã‚’æ’®ã£ã¦èª­ã¿å–ã‚‹
            </button>
            <button id="btn-camera" class="btn btn-secondary" onclick="startCameraScan()">
                ğŸ¥ ãƒ©ã‚¤ãƒ–ã‚«ãƒ¡ãƒ©ã§ã‚¹ã‚­ãƒ£ãƒ³
            </button>
            <button id="btn-stop" class="btn btn-stop" onclick="stopCameraScan()">
                â¹ ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢
            </button>
        </div>

        <input type="file" id="file-input" accept="image/*" capture="environment" onchange="processFile(this)">

        <div class="card">
            <div id="status-bar" class="status-bar">
                <span class="status-icon">â³</span>
                <span id="status-text" class="status-text">QRã‚³ãƒ¼ãƒ‰å¾…æ©Ÿä¸­</span>
            </div>

            <div class="field">
                <div class="field-label">ãŠåå‰</div>
                <div class="field-value" id="disp-name">â€”</div>
            </div>
            <div class="field">
                <div class="field-label">ç”Ÿå¹´æœˆæ—¥</div>
                <div class="field-value" id="disp-birth">â€”</div>
            </div>
            <div class="field">
                <div class="field-label">å‡¦æ–¹å†…å®¹</div>
                <div class="drug-list" id="disp-drugs">èª­ã¿å–ã‚Šå¾…æ©Ÿä¸­...</div>
            </div>
        </div>

        <button id="btn-submit" class="btn btn-submit hidden" onclick="submitToJotForm()">
            âœ‰ï¸ JotFormã¸é€ä¿¡
        </button>
        <button class="btn btn-reset" onclick="resetAll()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>

        <div id="debug-log"></div>
    </div>

    <script>
        // --- Configuration ---
        const MY_LIFF_ID = "2008819728-et8sw7Ou";
        const JOTFORM_ID = "253620819353054";

        // --- State ---
        let scanning = false;
        let video = null;
        let canvas = null;
        let ctx = null;
        let stream = null;

        // JAHIS Data State
        // { parity: number, total: number, chunks: { [index]: Uint8Array } }
        let session = null;

        let patientInfo = { name: "", kana: "", birth: "" };
        let drugList = [];
        let rawCsvLines = [];

        // --- Debug Logging ---
        function log(msg) {
            console.log(msg);
            const d = document.getElementById("debug-log");
            if (d) {
                d.style.display = "block";
                const t = new Date().toLocaleTimeString();
                d.textContent = `[${t}] ${msg}\n` + d.textContent;
            }
        }

        // --- Init ---
        window.onload = () => {
            log("Initializing...");
            video = document.getElementById("video");
            canvas = document.getElementById("canvas");
            ctx = canvas.getContext("2d", { willReadFrequently: true });

            if (typeof jsQR === 'undefined') {
                log("Error: jsQR library not loaded. Check internet connection.");
                alert("ã‚¨ãƒ©ãƒ¼: QRè§£æãƒ©ã‚¤ãƒ–ãƒ©ãƒª(jsQR)ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                return;
            } else {
                log("jsQR library loaded successfully.");
            }

            liff.init({ liffId: MY_LIFF_ID })
                .then(() => {
                    log("LIFF Init Success");
                    if (!liff.isLoggedIn()) {
                        log("Not logged in, calling login...");
                        liff.login();
                    }
                })
                .catch(e => {
                    log("LIFF Init Error: " + e);
                });
        };

        // --- File Scanning (Photo) ---
        function takePhoto() {
            document.getElementById("file-input").click();
        }

        function processFile(input) {
            if (!input.files || input.files.length === 0) return;
            const file = input.files[0];

            setStatus("processing", "è§£æä¸­...");

            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code) {
                    handleQrCode(code);
                } else {
                    setStatus("error", "QRã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                    alert("QRã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\né®®æ˜ãªå†™çœŸã‚’å†åº¦æ’®å½±ã—ã¦ãã ã•ã„ã€‚");
                }
                URL.revokeObjectURL(img.src);
            };
            img.onerror = () => {
                setStatus("error", "ç”»åƒã‚¨ãƒ©ãƒ¼");
            };
            img.src = URL.createObjectURL(file);
            input.value = ""; // reset
        }

        // --- Live Camera Scanning ---
        async function startCameraScan() {
            document.getElementById("media-container").style.display = "block";
            document.getElementById("btn-photo").classList.add("hidden");
            document.getElementById("btn-camera").classList.add("hidden");
            document.getElementById("btn-stop").style.display = "flex";
            setStatus("processing", "ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­(é«˜ç”»è³ª)...");
            log("Starting camera (1080p)...");

            try {
                // Request High Resolution for dense QR codes
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment",
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        focusMode: "continuous" // Experimental
                    }
                });
                log("Camera stream obtained");
                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    log("Video metadata: " + video.videoWidth + "x" + video.videoHeight);
                    video.play().then(() => {
                        log("Video playing");
                        scanning = true;

                        // Check Native Support
                        if ('BarcodeDetector' in window) {
                            log("Native BarcodeDetector available.");
                            BarcodeDetector.getSupportedFormats().then(formats => {
                                log("Supported formats: " + formats.join(", "));
                            });
                        } else {
                            log("Native BarcodeDetector NOT available. Using jsQR.");
                        }

                        requestAnimationFrame(scanLoop);
                        setStatus("processing", "QRã‚³ãƒ¼ãƒ‰ã‚’æ˜ ã—ã¦ãã ã•ã„");
                    }).catch(e => {
                        log("Video play error: " + e);
                        alert("ãƒ“ãƒ‡ã‚ªå†ç”Ÿã‚¨ãƒ©ãƒ¼: " + e);
                    });
                };
            } catch (err) {
                console.error(err);
                log("Camera Error: " + err);
                alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + err);
                stopCameraScan();
            }
        }

        function stopCameraScan() {
            scanning = false;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            document.getElementById("media-container").style.display = "none";
            document.getElementById("btn-photo").classList.remove("hidden");
            document.getElementById("btn-camera").classList.remove("hidden");
            document.getElementById("btn-stop").style.display = "none";

            if (session === null) {
                setStatus("idle", "QRã‚³ãƒ¼ãƒ‰å¾…æ©Ÿä¸­");
            }
        }

        async function scanLoop() {
            if (!scanning) return;

            if (video.readyState === video.HAVE_ENOUGH_DATA) {

                // 1. Try Native BarcodeDetector (Mainly for Android/macOS/Chrome)
                // This is much faster and reads dense codes better, BUT returns String (Utf8).
                // We will try it. If it hits, we use it. 
                if ('BarcodeDetector' in window) {
                    try {
                        const detector = new BarcodeDetector({ formats: ['qr_code'] });
                        const barcodes = await detector.detect(video);
                        if (barcodes.length > 0) {
                            for (const barcode of barcodes) {
                                log("Native Detect: " + barcode.rawValue);
                                // Native usually auto-decodes to UTF-8. 
                                // JAHIS Shift-JIS might become garbled.
                                // But detection is priority #1.
                                handleDetectedText(barcode.rawValue);
                                if (!scanning) return; // Stop if success
                            }
                        }
                    } catch (e) {
                        // log("Native detection failed: " + e);
                    }
                }

                // 2. Fallback to jsQR (Canvas)
                // Only run if native didn't catch (or running parallel)
                if (scanning) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });

                    if (code) {
                        log("jsQR Found (Binary)!");
                        handleQrCode(code); // Calls binary handler
                    }
                }
            }
            if (scanning) requestAnimationFrame(scanLoop);
        }

        // --- Handlers ---

        // Handler for Text (Native)
        function handleDetectedText(text) {
            // De-dupe logic
            if (rawCsvLines.join("\n").includes(text)) return;

            // If Native detector corrupted Shift-JIS, 'text' might be mojibake.
            // We can try to guess or just let it pass if detection is the blocker.
            // User wants reaction first.

            log("Processing Text: " + text.substring(0, 20));
            if (navigator.vibrate) navigator.vibrate(100);

            // Simple Add
            const lines = text.split(/\r\n|\n|\r/);
            const validLines = lines.filter(l => l.trim().length > 0);
            if (validLines.length > 0) {
                validLines.forEach(l => {
                    if (!rawCsvLines.includes(l)) rawCsvLines.push(l);
                });
                parseJAHISData(rawCsvLines);
                updateDisplay();
                setStatus("success", "èª­ã¿å–ã‚ŠæˆåŠŸ (Native)");

                // Stop or Pause?
                scanning = false; // Stop for safety to check result
                setTimeout(() => {
                    if (confirm("ç¶šã‘ã¦ã‚¹ã‚­ãƒ£ãƒ³ã—ã¾ã™ã‹ï¼Ÿ")) {
                        scanning = true;
                        setStatus("processing", "ã‚¹ã‚­ãƒ£ãƒ³ä¸­...");
                        requestAnimationFrame(scanLoop);
                    } else {
                        stopCameraScan();
                    }
                }, 500);
            }
        }

        // Handler for Binary (jsQR)
        function handleQrCode(code) {
            const rawBytes = code.binaryData;
            let text = "";
            try {
                const decoder = new TextDecoder("shift-jis");
                text = decoder.decode(rawBytes);
            } catch (e) {
                log("Decoder error: " + e);
                return false;
            }

            // Logic similar to text handler...
            if (rawCsvLines.join("\n").includes(text)) return false;

            log("jsQR Decoded: " + text.substring(0, 20));
            handleDetectedText(text); // Reuse text handler
            return true;
        }



        // --- JAHIS CSV Parser ---
        function parseJAHISData(lines) {
            // Reset
            patientInfo = { name: "", kana: "", birth: "" };
            drugList = [];

            // JAHIS Spec:
            // 1: Header
            // 5: Patient Info
            // 11: Insurance
            // 51: Medical Inst
            // 201: Usage (RP)
            // 211: Drug

            // Sort lines? No, order matters for 201->211 hierarchy.
            // However, with random scanning order, we might break the hierarchy.
            // Ideally we need the correct order.
            // Assuming the user scans in order 1->2->3 is best effort.

            let currentUsage = "";

            /* 
              Typical Line: "5,å†…ç§‘ å¤ªéƒ,ï¾…ï½²ï½¶ ï¾€ï¾›ï½³,1,19800101,..."
            */

            lines.forEach(line => {
                const cols = line.split(",");
                const type = cols[0];

                // 5: Patient Info
                // 5,Name,Kana,Sex,BirthDate(YYYYMMDD),...
                if (type === "5") {
                    if (cols[1]) patientInfo.name = cols[1];
                    if (cols[2]) patientInfo.kana = cols[2];
                    if (cols[4] && cols[4].length === 8) {
                        const d = cols[4];
                        patientInfo.birth = `${d.substring(0, 4)}/${d.substring(4, 6)}/${d.substring(6, 8)}`;
                    }
                }

                // Fallback for older formats or misinterpretation (Record 11 sometimes used in other contexts?)
                // JAHIS Ver 1.x uses distinct records.

                // 201: Usage (Recipe)
                // 201,ReceiptNo,UsageName,...
                if (type === "201") {
                    // col[1] is Usage Name/Code usually, or col[2]?
                    // Spec: 201, RP No, Usage Name, ...
                    // Example: 201,1,ï¼‘æ—¥ï¼“å›æ¯é£Ÿå¾Œ,,,,
                    if (cols[2]) {
                        currentUsage = cols[2];
                    }
                }

                // 211: Drug
                // 211,RP No,DrugCode,DrugName,Amount,Unit,...
                if (type === "211") {
                    // Example: 211,1,123456789,ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³éŒ ï¼•ï½ï½‡,1,éŒ ,...
                    const name = cols[3] || "ä¸æ˜ãªè–¬å“";
                    const amount = cols[4] || "";
                    const unit = cols[5] || "";

                    let text = `ãƒ»${name} ${amount}${unit}`;
                    if (currentUsage) {
                        text += ` (${currentUsage})`;
                    }
                    drugList.push(text);
                }

                // 111: Comment/Remark (Sometimes used for free text usage)
                if (type === "111") {
                    // 111,RemarkCode,RemarkText...
                    if (cols[2]) {
                        drugList.push(`  (å‚™è€ƒ: ${cols[2]})`);
                    }
                }
            });
        }

        // --- UI ---
        function updateDisplay() {
            document.getElementById("disp-name").textContent = patientInfo.name || "â€”";
            document.getElementById("disp-birth").textContent = patientInfo.birth || "â€”";

            if (drugList.length > 0) {
                document.getElementById("disp-drugs").textContent = drugList.join("\n");
            } else {
                document.getElementById("disp-drugs").textContent = rawCsvLines.length > 0 ? "ï¼ˆå‡¦æ–¹ãƒ‡ãƒ¼ã‚¿è§£æä¸­...ï¼‰" : "èª­ã¿å–ã‚Šå¾…æ©Ÿä¸­...";
            }

            if (patientInfo.name || drugList.length > 0) {
                document.getElementById("btn-submit").classList.remove("hidden");
            }
        }

        function setStatus(type, msg) {
            const bar = document.getElementById("status-bar");
            const text = document.getElementById("status-text");
            const icon = bar.querySelector(".status-icon");

            bar.className = "status-bar";
            if (type === "success") {
                bar.classList.add("success");
                icon.textContent = "âœ…";
            } else if (type === "processing") {
                bar.classList.add("processing");
                icon.textContent = "ğŸ“·";
            } else if (type === "error") {
                icon.textContent = "âš ï¸";
            } else {
                icon.textContent = "â³";
            }
            text.textContent = msg;
        }

        function resetAll() {
            if (!confirm("ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;

            rawCsvLines = [];
            patientInfo = { name: "", kana: "", birth: "" };
            drugList = [];
            session = null;

            updateDisplay();
            setStatus("idle", "QRã‚³ãƒ¼ãƒ‰å¾…æ©Ÿä¸­");

            if (scanning) stopCameraScan();

            // Clean URL params if any (optional)
        }

        // --- Submit ---
        function submitToJotForm() {
            if (!patientInfo.name && drugList.length === 0) {
                alert("é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
                return;
            }

            const params = new URLSearchParams({
                // Note: These keys must match your JotForm 'Unique Name' settings
                name: patientInfo.name,
                name_kana: patientInfo.kana, // Assuming you might have a hidden field or separate one
                birthdate: patientInfo.birth,
                prescription: drugList.join("\n")
            });
            // Source tracking
            params.append("source", "line_qr_v4");

            const url = `https://form.jotform.com/${JOTFORM_ID}?${params.toString()}`;

            // Open in LIFF or External
            liff.openWindow({ url: url, external: false });
        }

    </script>
</body>

</html>
