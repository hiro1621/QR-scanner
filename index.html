<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>処方箋QRスキャナー プロトタイプ</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        body { font-family: sans-serif; text-align: center; margin: 0; padding: 20px; }
        #video { width: 100%; max-width: 500px; border: 1px solid #ccc; border-radius: 8px; }
        #status { margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 5px; }
        .progress { color: #007bff; font-weight: bold; }
    </style>
</head>
<body>
    <h2>処方箋QRスキャン</h2>
    <video id="video"></video>
    
    <div id="status">
        <p id="message">QRコードをカメラに向けてください</p>
        <div id="progress" class="progress"></div>
    </div>

    <script>
        const codeReader = new ZXing.BrowserMultiFormatReader();
        const videoElement = document.getElementById('video');
        const messageElement = document.getElementById('message');
        const progressElement = document.getElementById('progress');

        // セッション管理用
        let scanSession = {
            parity: null,
            totalCount: 0,
            segments: {},
        };

        // カメラ開始
        codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
            if (result) {
                handleResult(result);
            }
        });

        function handleResult(result) {
            const meta = result.resultMetadata;
            
            // 連結QR情報の取得（報告書 第6.1章のロジック）
            if (meta && meta.has(ZXing.ResultMetadataType.STRUCTURED_APPEND_SEQUENCE)) {
                const seqInfo = meta.get(ZXing.ResultMetadataType.STRUCTURED_APPEND_SEQUENCE);
                const parity = meta.get(ZXing.ResultMetadataType.STRUCTURED_APPEND_PARITY);
                const index = (seqInfo >> 4) & 0x0F;
                const total = (seqInfo & 0x0F) + 1;

                // 異なる処方箋の混入チェック
                if (scanSession.parity !== null && scanSession.parity !== parity) {
                    alert("別の処方箋が混ざっています。");
                    return;
                }

                // セッション初期化
                if (scanSession.parity === null) {
                    scanSession.parity = parity;
                    scanSession.totalCount = total;
                }

                // セグメントの保存
                if (!scanSession.segments[index]) {
                    scanSession.segments[index] = result.rawBytes; // 生バイナリを保持
                    const currentCount = Object.keys(scanSession.segments).length;
                    progressElement.innerText = `${currentCount} / ${total} 枚読み取り完了`;
                    
                    if (currentCount === total) {
                        finalizeScanning();
                    }
                }
            } else {
                // 単一QRの場合
                processFinalData(result.rawBytes);
            }
        }

        function finalizeScanning() {
            // インデックス順に結合
            const sortedKeys = Object.keys(scanSession.segments).map(Number).sort((a, b) => a - b);
            let totalLength = sortedKeys.reduce((acc, k) => acc + scanSession.segments[k].length, 0);
            let combined = new Uint8Array(totalLength);
            let offset = 0;
            sortedKeys.forEach(k => {
                combined.set(scanSession.segments[k], offset);
                offset += scanSession.segments[k].length;
            });
            processFinalData(combined);
        }

        function processFinalData(uint8Array) {
            // Shift-JISでデコード
            const decoder = new TextDecoder("shift-jis");
            const csvText = decoder.decode(uint8Array);
            
            // 簡易パースしてJotformへ（報告書 第7章）
            const formData = simpleParse(csvText);
            redirectToJotform(formData);
        }

        function simpleParse(csv) {
            const lines = csv.split(/\r\n|\n|\r/);
            let data = { name: "", medications: [] };
            lines.forEach(line => {
                const cols = line.split(",");
                if (cols[0] === "5") data.name = cols[1]; // 氏名
                if (cols[0] === "211") data.medications.push(cols[3]); // 薬品名
            });
            return data;
        }

        function redirectToJotform(data) {
            const formID = "YOUR_FORM_ID"; // 本間様のJotform ID
            const baseUrl = `https://form.jotform.com/${formID}`;
            const params = new URLSearchParams();
            params.append("fullName", data.name);
            params.append("medications", data.medications.join("\n"));
            window.location.href = `${baseUrl}?${params.toString()}`; // 自動入力遷移
        }
    </script>
</body>
</html>